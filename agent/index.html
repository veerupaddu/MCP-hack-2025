<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Story Agent - Alex</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .options {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .story {
            background: #f8fafc;
            border-left: 4px solid #667eea;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
        }

        .story-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .story-id {
            font-size: 0.9rem;
            font-weight: 700;
            color: #667eea;
        }

        .story-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 1rem;
        }

        .story-format {
            margin-bottom: 1rem;
            line-height: 1.8;
        }

        .story-format strong {
            color: #667eea;
        }

        .criteria {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .criteria h4 {
            font-size: 0.9rem;
            color: #667eea;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .criteria ul {
            list-style: none;
            padding-left: 0;
        }

        .criteria li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .criteria li:last-child {
            border-bottom: none;
        }

        .story-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-points {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-priority-high {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-priority-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-priority-low {
            background: #d1fae5;
            color: #065f46;
        }

        .metadata {
            background: #f0f9ff;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .metadata p {
            margin: 0.5rem 0;
        }

        .warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .expandable-section {
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .expandable-header {
            background: #f8fafc;
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
            user-select: none;
        }

        .expandable-header:hover {
            background: #f1f5f9;
        }

        .expandable-header h3 {
            margin: 0;
            font-size: 1rem;
            color: #1a202c;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .expandable-icon {
            font-size: 1.2rem;
            transition: transform 0.3s;
        }

        .expandable-icon.open {
            transform: rotate(180deg);
        }

        .expandable-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .expandable-content.open {
            max-height: 1000px;
            transition: max-height 0.5s ease-in;
        }

        .expandable-body {
            padding: 1rem;
            background: white;
        }

        .source-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 6px;
            margin-bottom: 0.75rem;
        }

        .source-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .source-details h4 {
            margin: 0 0 0.25rem 0;
            font-size: 0.9rem;
            color: #667eea;
        }

        .source-details p {
            margin: 0;
            font-size: 0.85rem;
            color: #64748b;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f0f9ff;
            border-left: 3px solid #3b82f6;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .thought-step {
            padding: 1rem;
            background: #f9fafb;
            border-left: 3px solid #10b981;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .thought-step h4 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            color: #10b981;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .thought-step p {
            margin: 0;
            color: #374151;
            line-height: 1.6;
        }

        .toggle-all {
            text-align: right;
            margin-bottom: 1rem;
        }

        .toggle-all button {
            background: none;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .toggle-all button:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üë§ User Story Agent</h1>
            <p>Alex - Senior Product Owner & Business Analyst</p>
        </div>

        <div class="card">
            <form id="storyForm">
                <div class="form-group">
                    <label for="query">Enter your requirement:</label>
                    <textarea id="query" name="query" rows="4"
                        placeholder="Example: I need a feature for customers to file auto insurance claims online with photo uploads..."
                        required></textarea>
                </div>

                <div class="options">
                    <div class="checkbox-group">
                        <input type="checkbox" id="useRag" name="use_rag" checked>
                        <label for="useRag" style="margin: 0;">Use RAG (Knowledge Base)</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="useFinetuned" name="use_finetuned" checked>
                        <label for="useFinetuned" style="margin: 0;">Use Fine-tuned Model</label>
                    </div>
                </div>

                <div class="rag-sources" id="ragSources"
                    style="display: flex; gap: 1.5rem; margin-bottom: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                    <div style="font-weight: 600; color: #667eea;">RAG Sources:</div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="ragExisting" name="rag_existing" checked>
                        <label for="ragExisting" style="margin: 0; font-size: 0.9rem;">üìÑ Existing Products
                            (PDFs)</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="ragDesign" name="rag_design" checked>
                        <label for="ragDesign" style="margin: 0; font-size: 0.9rem;">üìù Product Design (DOCX)</label>
                    </div>
                </div>

                <button type="submit" class="btn" id="submitBtn">
                    Generate User Stories
                </button>
            </form>
        </div>


        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Alex is analyzing your requirement and generating user stories...</p>
        </div>

        <div class="results card" id="results">
            <h2 style="margin-bottom: 1.5rem;">Generated User Stories</h2>

            <div class="toggle-all">
                <button onclick="toggleAllSections()">Expand/Collapse All Details</button>
            </div>

            <!-- Expandable Sections -->
            <div id="expandableSections"></div>

            <div id="storiesContainer"></div>
            <div id="metadataContainer"></div>
        </div>
    </div>

    <script>
        const form = document.getElementById('storyForm');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const submitBtn = document.getElementById('submitBtn');
        const ragSources = document.getElementById('ragSources');

        // Toggle RAG sources visibility based on RAG checkbox
        document.getElementById('useRag').addEventListener('change', function () {
            ragSources.style.display = this.checked ? 'flex' : 'none';
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const query = document.getElementById('query').value;
            const useRag = document.getElementById('useRag').checked;
            const useFinetuned = document.getElementById('useFinetuned').checked;
            const ragExisting = document.getElementById('ragExisting').checked;
            const ragDesign = document.getElementById('ragDesign').checked;

            // Determine RAG source
            let ragSource = 'auto';
            if (useRag) {
                if (ragExisting && ragDesign) ragSource = 'both';
                else if (ragExisting) ragSource = 'existing';
                else if (ragDesign) ragSource = 'design';
                else ragSource = 'none';
            }

            // Show loading
            loading.classList.add('active');
            results.classList.remove('active');
            submitBtn.disabled = true;

            try {
                const response = await fetch('http://localhost:8001/api/user-stories', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        use_rag: useRag,
                        use_finetuned: useFinetuned,
                        rag_source: ragSource
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayResults(data);
                } else {
                    alert('Error generating user stories');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to connect to the API. Make sure the server is running on port 8001.');
            } finally {
                loading.classList.remove('active');
                submitBtn.disabled = false;
            }
        });


        function displayResults(data) {
            const storiesContainer = document.getElementById('storiesContainer');
            const metadataContainer = document.getElementById('metadataContainer');
            const expandableSections = document.getElementById('expandableSections');

            // Display expandable sections
            let expandableHtml = '';

            // 1. Sources Used Section
            expandableHtml += createExpandableSection(
                'sources',
                'üîó Sources & Data Retrieved',
                generateSourcesContent(data)
            );

            // 2. Files & Context Section
            expandableHtml += createExpandableSection(
                'files',
                'üìÅ Retrieved Files & Context',
                generateFilesContent(data)
            );

            // 3. Thought Process Section
            expandableHtml += createExpandableSection(
                'thought',
                'üß† Agent Reasoning & Thought Process',
                generateThoughtProcessContent(data)
            );

            expandableSections.innerHTML = expandableHtml;

            // Display warnings if any
            let warningsHtml = '';
            if (data.warnings && data.warnings.length > 0) {
                warningsHtml = `
                    <div class="warning">
                        <strong>‚ö†Ô∏è Warnings:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem;">
                            ${data.warnings.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Display stories
            const storiesHtml = data.stories.map(story => `
                <div class="story">
                    <div class="story-header">
                        <span class="story-id">${story.story_id}</span>
                    </div>
                    <div class="story-title">${story.title}</div>
                    <div class="story-format">
                        <strong>As a</strong> ${story.actor},<br>
                        <strong>I want</strong> ${story.action},<br>
                        <strong>So that</strong> ${story.benefit}.
                    </div>
                    <div class="criteria">
                        <h4>Acceptance Criteria</h4>
                        <ul>
                            ${story.acceptance_criteria.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    </div>
                    ${story.technical_notes && story.technical_notes.length > 0 ? `
                        <div class="criteria">
                            <h4>Technical Notes</h4>
                            <ul>
                                ${story.technical_notes.map(n => `<li>${n}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    <div class="story-meta">
                        <span class="badge badge-points">${story.story_points} Story Points</span>
                        <span class="badge badge-priority-${story.priority.toLowerCase()}">${story.priority} Priority</span>
                    </div>
                </div>
            `).join('');

            // Display metadata
            const metadataHtml = `
                <div class="metadata">
                    <p><strong>Domain:</strong> ${data.domain}</p>
                    <p><strong>MCP Source:</strong> ${data.mcp_source}</p>
                    <p><strong>Confidence:</strong> ${Math.round(data.confidence * 100)}%</p>
                    <p><strong>Total Stories:</strong> ${data.stories.length}</p>
                </div>
            `;

            storiesContainer.innerHTML = warningsHtml + storiesHtml;
            metadataContainer.innerHTML = metadataHtml;
            results.classList.add('active');

            // Scroll to results
            results.scrollIntoView({ behavior: 'smooth' });
        }

        function createExpandableSection(id, title, content) {
            return `
                <div class="expandable-section">
                    <div class="expandable-header" onclick="toggleSection('${id}')">
                        <h3><span>${title}</span></h3>
                        <span class="expandable-icon" id="${id}-icon">‚ñº</span>
                    </div>
                    <div class="expandable-content" id="${id}-content">
                        <div class="expandable-body">
                            ${content}
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleSection(id) {
            const content = document.getElementById(`${id}-content`);
            const icon = document.getElementById(`${id}-icon`);

            content.classList.toggle('open');
            icon.classList.toggle('open');
        }

        function toggleAllSections() {
            const sections = ['sources', 'files', 'thought'];
            const firstSection = document.getElementById('sources-content');
            const shouldOpen = !firstSection.classList.contains('open');

            sections.forEach(id => {
                const content = document.getElementById(`${id}-content`);
                const icon = document.getElementById(`${id}-icon`);

                if (shouldOpen) {
                    content.classList.add('open');
                    icon.classList.add('open');
                } else {
                    content.classList.remove('open');
                    icon.classList.remove('open');
                }
            });
        }

        function generateSourcesContent(data) {
            const sources = [];

            if (data.mcp_source.includes('RAG')) {
                sources.push({
                    icon: 'üîç',
                    name: 'RAG (Retrieval-Augmented Generation)',
                    description: 'Retrieved relevant product specifications and design patterns from knowledge base'
                });
            }

            if (data.mcp_source.includes('Fine-tuned')) {
                sources.push({
                    icon: 'üß†',
                    name: 'Fine-tuned Domain Model',
                    description: 'Applied domain-specific knowledge from trained insurance model'
                });
            }

            sources.push({
                icon: 'üë§',
                name: 'Alex (User Story Agent)',
                description: 'Senior Product Owner persona applying INVEST principles and best practices'
            });

            return sources.map(source => `
                <div class="source-item">
                    <div class="source-icon">${source.icon}</div>
                    <div class="source-details">
                        <h4>${source.name}</h4>
                        <p>${source.description}</p>
                    </div>
                </div>
            `).join('');
        }

        function generateFilesContent(data) {
            // Show actual RAG collections that were queried
            const ragExisting = document.getElementById('ragExisting').checked;
            const ragDesign = document.getElementById('ragDesign').checked;

            const files = [];

            if (ragExisting) {
                files.push({ name: 'existing_products', type: 'Existing Products Collection', icon: 'üìÑ', folder: 'aig/, metlife/, sonpo/, japan_post/' });
            }

            if (ragDesign) {
                files.push({ name: 'product_design', type: 'Product Design Collection', icon: 'üìù', folder: 'docs/' });
            }

            if (!data.mcp_source || data.mcp_source === 'Fallback' || files.length === 0) {
                return '<p style="color: #64748b;">No external files were retrieved. Stories generated using fallback logic.</p>';
            }

            return `
                <p style="margin-bottom: 1rem; color: #64748b;">RAG Collections queried:</p>
                ${files.map(file => `
                    <div class="file-item">
                        <span>${file.icon}</span>
                        <span style="flex: 1;"><strong>${file.name}</strong><br><small style="color: #64748b;">${file.folder}</small></span>
                        <span style="color: #667eea; font-size: 0.8rem;">${file.type}</span>
                    </div>
                `).join('')}
                <p style="margin-top: 1rem; font-size: 0.85rem; color: #64748b;">
                    Source files include: Insurance PDFs (AIG, MetLife, Sonpo, Japan Post) and Product Design documents (DOCX/XLSX)
                </p>
            `;
        }

        function generateThoughtProcessContent(data) {
            const steps = [
                {
                    icon: 'üìù',
                    title: 'Step 1: Requirement Analysis',
                    description: `Analyzed the user query: "${data.raw_query.substring(0, 100)}${data.raw_query.length > 100 ? '...' : ''}"`
                },
                {
                    icon: 'üéØ',
                    title: 'Step 2: Actor Identification',
                    description: `Identified primary actors: ${data.stories.map(s => s.actor).filter((v, i, a) => a.indexOf(v) === i).join(', ')}`
                },
                {
                    icon: 'üîç',
                    title: 'Step 3: Context Retrieval',
                    description: `Queried MCP sources: ${data.mcp_source}. Retrieved relevant product specifications and domain knowledge.`
                },
                {
                    icon: '‚úçÔ∏è',
                    title: 'Step 4: Story Generation',
                    description: `Generated ${data.stories.length} user stories following INVEST principles (Independent, Negotiable, Valuable, Estimable, Small, Testable)`
                },
                {
                    icon: '‚úÖ',
                    title: 'Step 5: Acceptance Criteria',
                    description: 'Created testable acceptance criteria using Given-When-Then format for each story'
                },
                {
                    icon: 'üìä',
                    title: 'Step 6: Estimation & Prioritization',
                    description: 'Applied story point estimation based on complexity and assigned priorities based on business value'
                }
            ];

            return steps.map(step => `
                <div class="thought-step">
                    <h4><span>${step.icon}</span> ${step.title}</h4>
                    <p>${step.description}</p>
                </div>
            `).join('');
        }
    </script>
</body>

</html>